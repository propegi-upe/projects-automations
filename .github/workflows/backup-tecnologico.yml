# Nome do workflow (aparece no GitHub Actions)
name: Backup Di谩rio Projetos Tecnol贸gicos

# Eventos que disparam o workflow:
on:
  # Agenda o backup para rodar automaticamente todos os dias s 03:30 UTC (21:30 BRT)
  #  Ajustei o cron para um hor谩rio ligeiramente diferente para n茫o colidirem
  schedule:
    - cron: '30 21 * * *'
  # Permite rodar manualmente pelo bot茫o "Run workflow"
  workflow_dispatch:

# Permiss玫es necess谩rias para o workflow
permissions:
  contents: write # Permite fazer push (commit) no reposit贸rio

jobs:
  backup:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: automation #  Define o diret贸rio padr茫o para os comandos

    steps:
      # Etapa 1: Fazer checkout do c贸digo
      - name: Checkout do reposit贸rio
        uses: actions/checkout@v3
        with:
          ref: main #  sempre na branch backups

      # Etapa 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      # Etapa 3: Instalar depend锚ncias na pasta automation
      - name: Instalar depend锚ncias
        run: npm ci # usa package-lock.json e integra com cache

      # Etapa 4b: Executar script de backup para o projeto Tecnol贸gico
      - name: Executar script de backup (Tecnol贸gico)
        env:
          REPOSITORY_ACCESS_TOKEN: ${{ secrets.REPOSITORY_ACCESS_TOKEN }}
          #  CHAVE DO PROJETO: Deve corresponder  chave no script JS (technological-development)
          PROJECT_KEY: technological-development
        run: npx tsx scripts/backup.use-case.ts

      # Etapa 5: Commit e push dos backups
      - name: Commit e push dos backups
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          #  APENAS o diret贸rio do projeto Tecnol贸gico
          git add data/backups/technological-development/
          git commit -m "Backup di谩rio Tecnol贸gico: $(date +'%Y-%m-%d')" || echo "Nenhuma mudan莽a para commitar"
          git push