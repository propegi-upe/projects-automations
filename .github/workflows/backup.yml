# Nome do workflow (aparece no GitHub Actions)
name: Backup Di√°rio de Tarefas

# Eventos que disparam o workflow:
on:
  # Agenda o backup para rodar automaticamente todos os dias √†s 03h UTC
  schedule:
    - cron: '15 21 * * *'
  # Permite rodar manualmente pelo bot√£o "Run workflow"
  workflow_dispatch:

# Permiss√µes necess√°rias para o workflow
permissions:
  contents: write # Permite fazer push (commit) no reposit√≥rio

jobs:
  backup:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: automation # üëâ Define o diret√≥rio padr√£o para os comandos

    steps:
      # Etapa 1: Fazer checkout do c√≥digo
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v3

      # Etapa 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # Etapa 3: Instalar depend√™ncias na pasta automation
      - name: Instalar depend√™ncias
        run: npm install

      # Etapa 4: Executar script de backup
      - name: Executar script de backup
        env:
          REPOSITORY_ACCESS_TOKEN: ${{ secrets.REPOSITORY_ACCESS_TOKEN }}
        run: npx tsx scripts/backup.ts

      # Etapa 5: Commit e push dos backups
      - name: Commit e push dos backups
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/backups/
          git commit -m "Backup di√°rio: $(date +'%Y-%m-%d')" || echo "Nenhuma mudan√ßa para commitar"
          git push
