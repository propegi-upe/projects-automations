# Nome do workflow (aparece no GitHub Actions)
name: Backup Di√°rio PROPEGI Financeiro

# Eventos que disparam o workflow:
on:
  # Agenda o backup para rodar automaticamente todos os dias √†s 03:15 UTC (21:15 BRT)
  schedule:
    - cron: '15 21 * * *'
  # Permite rodar manualmente pelo bot√£o "Run workflow"
  workflow_dispatch:

# Permiss√µes necess√°rias para o workflow
permissions:
  contents: write # Permite fazer push (commit) no reposit√≥rio

jobs:
  backup:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: automation # üëâ Define o diret√≥rio padr√£o para os comandos

    steps:
      # Etapa 1: Fazer checkout do c√≥digo (com retry autom√°tico)
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v3
        with:
          ref: main # üëâ sempre na branch backups

      # Etapa 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      # Etapa 3: Instalar depend√™ncias na pasta automation
      - name: Instalar depend√™ncias
        run: npm ci # usa package-lock.json e integra com cache

      # Etapa 4b: Executar script de backup para o projeto Financeiro
      - name: Executar script de backup (Financeiro)
        env:
          REPOSITORY_ACCESS_TOKEN: ${{ secrets.REPOSITORY_ACCESS_TOKEN }}
          # üí° CHAVE DO PROJETO: Deve corresponder √† chave no script JS (financial-service)
          PROJECT_KEY: financial-service
        run: npx tsx scripts/backup.use-case.ts

      # Etapa 5: Commit e push dos backups
      - name: Commit e push dos backups
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          # üí° APENAS o diret√≥rio do projeto Financeiro
          git add data/backups/financial-service/
          git commit -m "Backup di√°rio Financeiro: $(date +'%Y-%m-%d')" || echo "Nenhuma mudan√ßa para commitar"
          git push
